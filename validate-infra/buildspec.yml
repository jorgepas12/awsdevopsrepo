version: 0.2

phases:
  install:
    runtime-versions:
      python: 3.10
    commands:
      - echo "ğŸ“¦ Instalando herramientas base..."
      - pip install cfn-lint==1.* awscli taskcat

      - echo "ğŸ›¡ï¸ Descargando cfn-guard desde S3..."
      - mkdir -p tools/bin
      - aws s3 cp s3://buildbucket1927/cfn-guard/cfn-guard-v3.1.2-linux.tar.gz cfn-guard.tar.gz
      - tar -xzf cfn-guard.tar.gz -C tools/bin
      - chmod +x tools/bin/cfn-guard

      - export PATH=$PWD/tools/bin:$PATH
      - echo "âœ… cfn-guard instalado en:"
      - which cfn-guard
      - cfn-guard --version

  pre_build:
    commands:
      - echo "ğŸ” ValidaciÃ³n con cfn-lint"
      - |
        cfn-lint cf-infra/networking.json || echo "âš ï¸ cfn-lint reportÃ³ advertencias, pero se continÃºa"

      - echo "ğŸ” ValidaciÃ³n con cfn-guard"
      - echo 'Resources.mycfvpc.Properties.CidrBlock == "10.3.0.0/16"' > rules.guard
      - echo 'Resources.mysecgroup.Properties.SecurityGroupIngress[*].FromPort == 80' >> rules.guard
      - cfn-guard validate -d cf-infra/networking.json -r rules.guard || echo "âš ï¸ cfn-guard terminÃ³ con advertencias"

  build:
    commands:
      - echo "ğŸ§ª Ejecutando pruebas con taskcat"
      - mkdir -p templates
      - cp cf-infra/networking.json templates/
      - taskcat test run || echo "âš ï¸ taskcat finalizÃ³ con errores o advertencias"

artifacts:
  files:
    - "**/*"
